// ==================== FIELD TECH SYNC ENDPOINTS ====================
// These endpoints allow the BP Field Tech app to sync data

// Endpoint for field tech app to pull properties
app.get('/api/sync/properties', async (req, res) => {
  try {
    const properties = await storage.getProperties();
    res.json({ properties });
  } catch (error: any) {
    console.error('Error fetching properties for sync:', error);
    res.status(500).json({ error: error.message });
  }
});

// Endpoint for field tech app to pull technicians
app.get('/api/sync/technicians', async (req, res) => {
  try {
    const technicians = await storage.getTechnicians();
    res.json({ technicians });
  } catch (error: any) {
    console.error('Error fetching technicians for sync:', error);
    res.status(500).json({ error: error.message });
  }
});

// Endpoint for field tech app to pull routes
app.get('/api/sync/routes', async (req, res) => {
  try {
    const routes = await storage.getRoutes();
    res.json({ routes });
  } catch (error: any) {
    console.error('Error fetching routes for sync:', error);
    res.status(500).json({ error: error.message });
  }
});

// Endpoint for field tech app to pull route stops
app.get('/api/sync/route-stops', async (req, res) => {
  try {
    const date = req.query.date as string | undefined;
    const stops = date 
      ? await storage.getRouteStopsByDate(date)
      : await storage.getAllRouteStops();
    res.json({ stops });
  } catch (error: any) {
    console.error('Error fetching route stops for sync:', error);
    res.status(500).json({ error: error.message });
  }
});

// Receive field entries from field tech app
app.post('/api/sync/field-entries', async (req, res) => {
  try {
    const { entry } = req.body;
    if (!entry) {
      return res.status(400).json({ error: 'entry required' });
    }
    
    // Check if entry already exists (by id)
    const existing = await storage.getFieldEntry(entry.id);
    if (existing) {
      // Update existing entry
      await storage.updateFieldEntry(entry.id, entry);
    } else {
      // Create new entry
      await storage.createFieldEntry(entry);
    }
    
    res.json({ success: true });
  } catch (error: any) {
    console.error('Error receiving field entry:', error);
    res.status(500).json({ error: error.message });
  }
});

// Receive estimates from field tech app
app.post('/api/sync/estimates', async (req, res) => {
  try {
    const { estimate } = req.body;
    if (!estimate) {
      return res.status(400).json({ error: 'estimate required' });
    }
    
    // Check if estimate already exists (by id)
    const existing = await storage.getEstimate(estimate.id);
    if (existing) {
      // Update existing estimate
      await storage.updateEstimate(estimate.id, estimate);
    } else {
      // Create new estimate
      await storage.createEstimate(estimate);
    }
    
    res.json({ success: true });
  } catch (error: any) {
    console.error('Error receiving estimate:', error);
    res.status(500).json({ error: error.message });
  }
});